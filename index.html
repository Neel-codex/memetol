<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>nnirvva SOL SNIPER • Modular</title>
  <style>
    body {margin:0;padding:16px;font-family:Arial,sans-serif;background:#000;color:#fff;line-height:1.5;}
    h1 {text-align:center;margin:0 0 20px;font-size:2.1rem;color:#0f8;text-shadow:0 0 8px #0f8;}
    .container {max-width:1400px;margin:0 auto;}
    .controls {text-align:center;margin:16px 0 24px;display:flex;flex-wrap:wrap;gap:10px;justify-content:center;}
    select,.btn {padding:9px 15px;margin:4px;border-radius:6px;border:1px solid #444;background:#111;color:white;font-size:0.95rem;}
    .btn {cursor:pointer;background:#004d33;border-color:#0c6;}
    .btn-connect {background:#222;border-color:#555;}
    .btn-connect:hover {background:#333;}
    .btn:disabled {opacity:0.5;cursor:not-allowed;}
    .wallet-info {text-align:center;margin:10px 0;color:#0f8;font-weight:bold;font-size:1.05rem;}
    .status {text-align:center;color:#aaa;margin:12px 0;font-size:0.95rem;}
    .error {color:#f44;}
    table {width:100%;border-collapse:collapse;background:#0a0a0a;border:1px solid #222;font-size:0.96rem;}
    th,td {padding:11px 9px;border-bottom:1px solid #222;text-align:left;}
    th {background:#111;color:#0f8;font-weight:normal;text-transform:uppercase;font-size:0.8rem;}
    tr:hover {background:#161616;}
    .buy-btn, .phantom-buy-btn {
      background:#004d33;
      color:#0f8;
      padding:7px 14px;
      border-radius:4px;
      border:1px solid #0c6;
      text-decoration:none;
      font-weight:bold;
      margin:0 4px;
    }
    .phantom-buy-btn {background:#1a3c2e;border-color:#0a6;}
    .phantom-buy-btn:disabled {opacity:0.5;cursor:not-allowed;}
    .positive {color:#0f8;}
    .negative {color:#f44;}
    .vol-high   {color:#00ff88;font-weight:bold;}
    .vol-medium {color:#88ff88;}
    .vol-low    {color:#ffff88;}
    .vol-weak   {color:#aaaaaa;}
    .ratio-strong-buy  {color:#00ff88;font-weight:bold;}
    .ratio-buy         {color:#88ff88;}
    .ratio-balanced    {color:#ffff88;}
    .ratio-sell        {color:#ff8888;}
    .ratio-strong-sell {color:#ff4444;font-weight:bold;}
    .chart-box {margin:30px 0;border:1px solid #222;background:#000;height:380px;overflow:hidden;border-radius:6px;position:relative;display:none;}
    .chart-box iframe {position:absolute;top:-85px;left:0;width:100%;height:760px;border:none;}
    .alert {padding:16px;margin:16px 0;border-radius:8px;text-align:center;font-weight:bold;font-size:1.15rem;display:none;}
    .alert-buy  {background:#002200;border:2px solid #0c6;color:#0f8;}
    .alert-sell {background:#220000;border:2px solid #f44;color:#f88;}
    @media (max-width:1100px){
      th:nth-child(4),td:nth-child(4),th:nth-child(9),td:nth-child(9){display:none;}
    }
    @media (max-width:800px){
      table,thead,tbody,th,td,tr{display:block;}
      thead tr{position:absolute;top:-9999px;left:-9999px;}
      tr{margin-bottom:18px;border:1px solid #333;border-radius:6px;background:#0f0f0f;}
      td{border:none;border-bottom:1px solid #222;position:relative;padding-left:48%;min-height:42px;}
      td:before{position:absolute;top:11px;left:10px;width:45%;padding-right:10px;white-space:nowrap;color:#aaa;content:attr(data-label);}
      td:last-child{text-align:center;padding:12px;border-bottom:none;}
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>nnirvva SOL SNIPER</h1>

    <div class="controls">
      <select id="liqFilter">
        <option value="0">Liq: Any</option>
        <option value="5000">> $5k</option>
        <option value="10000" selected>> $10k</option>
        <option value="25000">> $25k</option>
        <option value="50000">> $50k</option>
        <option value="100000">> $100k</option>
      </select>

      <select id="fdvFilter">
        <option value="999999999">FDV: Any</option>
        <option value="100000">FDV < $100k</option>
        <option value="250000">FDV < $250k</option>
        <option value="500000" selected>FDV < $500k</option>
        <option value="1000000">FDV < $1M</option>
      </select>

      <select id="volFilter">
        <option value="0">Vol 24h: Any</option>
        <option value="10000">> $10k</option>
        <option value="50000">> $50k</option>
        <option value="100000" selected>> $100k</option>
        <option value="250000">> $250k</option>
        <option value="500000">> $500k</option>
        <option value="1000000">> $1M</option>
      </select>

      <select id="ageFilter">
        <option value="999999999">Age: Any</option>
        <option value="300">Newer than 5 min</option>
        <option value="900">Newer than 15 min</option>
        <option value="3600" selected>Newer than 1h</option>
        <option value="21600">Newer than 6h</option>
        <option value="86400">Newer than 24h</option>
      </select>

      <button id="connectBtn" class="btn btn-connect">Connect Phantom</button>
    </div>

    <div class="wallet-info" id="walletInfo">Wallet: Not connected</div>
    <div class="status" id="status">Scanning fresh high-volume Solana launches...</div>

    <div id="buyAlert" class="alert alert-buy"></div>
    <div id="sellAlert" class="alert alert-sell"></div>

    <table>
      <thead>
        <tr>
          <th>Token</th>
          <th>Price</th>
          <th>24h %</th>
          <th>Vol 24h</th>
          <th>5m Txns</th>
          <th>5m Buy Tx</th>
          <th>5m Sell Tx</th>
          <th>B/S Ratio (5m)</th>
          <th>5m Vol</th>
          <th>Liq</th>
          <th>FDV</th>
          <th>Age</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="pairs"></tbody>
    </table>

    <div class="chart-box" id="chartArea">
      <iframe id="dexChart" title="DexScreener Chart"></iframe>
    </div>

    <div class="status">Auto-refresh every 60 seconds • Sorted by volume • Modular version</div>
  </div>

  <audio id="beep" src="https://www.soundjay.com/buttons/beep-07.mp3"></audio>

  <script>
    // ==============================================
    // CONFIG & CONSTANTS
    // ==============================================
    const CONFIG = {
      API_BASE: 'https://api.dexscreener.com/latest/dex',
      REFRESH_INTERVAL: 60000,
      DEFAULT_FILTERS: {
        minLiq: 10000,
        maxFdv: 500000,
        minVol: 100000,
        maxAge: 3600  // 1 hour
      },
      VOL_CLASSES: {
        high:   { min: 500000, class: 'vol-high'   },
        medium: { min: 100000, class: 'vol-medium' },
        low:    { min: 50000,  class: 'vol-low'    },
        weak:   { min: 0,      class: 'vol-weak'   }
      },
      RATIO_CLASSES: {
        strongBuy:  { min: 2.0, class: 'ratio-strong-buy'  },
        buy:        { min: 1.2, class: 'ratio-buy'         },
        balanced:   { min: 0.8, class: 'ratio-balanced'    },
        sell:       { min: 0.5, class: 'ratio-sell'        },
        strongSell: { min: 0,   class: 'ratio-strong-sell' }
      }
    };

    // ==============================================
    // STATE
    // ==============================================
    let state = {
      watching: null,
      prevBuyTx: 0,
      prevSellTx: 0,
      prevVol: 0,
      timer: null,
      provider: null,
      filters: { ...CONFIG.DEFAULT_FILTERS }
    };

    // DOM elements
    const els = {
      status: document.getElementById('status'),
      walletInfo: document.getElementById('walletInfo'),
      connectBtn: document.getElementById('connectBtn'),
      pairs: document.getElementById('pairs'),
      chartArea: document.getElementById('chartArea'),
      dexChart: document.getElementById('dexChart'),
      buyAlert: document.getElementById('buyAlert'),
      sellAlert: document.getElementById('sellAlert'),
      beep: document.getElementById('beep'),
      liqFilter: document.getElementById('liqFilter'),
      fdvFilter: document.getElementById('fdvFilter'),
      volFilter: document.getElementById('volFilter'),
      ageFilter: document.getElementById('ageFilter')
    };

    // ==============================================
    // HELPERS
    // ==============================================
    function getVolClass(vol) {
      vol = Number(vol) || 0;
      if (vol >= CONFIG.VOL_CLASSES.high.min) return CONFIG.VOL_CLASSES.high.class;
      if (vol >= CONFIG.VOL_CLASSES.medium.min) return CONFIG.VOL_CLASSES.medium.class;
      if (vol >= CONFIG.VOL_CLASSES.low.min) return CONFIG.VOL_CLASSES.low.class;
      return CONFIG.VOL_CLASSES.weak.class;
    }

    function getRatioClass(buys, sells) {
      if (sells === 0) return buys > 0 ? 'ratio-strong-buy' : 'vol-weak';
      if (buys === 0) return 'ratio-strong-sell';
      const ratio = buys / sells;
      if (ratio >= CONFIG.RATIO_CLASSES.strongBuy.min) return CONFIG.RATIO_CLASSES.strongBuy.class;
      if (ratio >= CONFIG.RATIO_CLASSES.buy.min) return CONFIG.RATIO_CLASSES.buy.class;
      if (ratio >= CONFIG.RATIO_CLASSES.balanced.min) return CONFIG.RATIO_CLASSES.balanced.class;
      if (ratio >= CONFIG.RATIO_CLASSES.sell.min) return CONFIG.RATIO_CLASSES.sell.class;
      return CONFIG.RATIO_CLASSES.strongSell.class;
    }

    function formatRatio(buys, sells) {
      if (sells === 0) return buys > 0 ? '∞:1' : '0:1';
      return (buys / sells).toFixed(1) + ':1';
    }

    // ==============================================
    // WALLET (Phantom)
    // ==============================================
    async function connectWallet() {
      const provider = window.solana || window.phantom?.solana;

      if (!provider || !provider.isPhantom) {
        els.status.textContent = "Phantom wallet not detected. Install from phantom.app";
        els.status.classList.add('error');
        return;
      }

      els.status.textContent = "Connecting to Phantom...";
      els.status.classList.remove('error');

      try {
        await provider.connect();
        const addr = provider.publicKey.toString();
        els.walletInfo.textContent = `Connected: ${addr.slice(0,6)}...${addr.slice(-4)}`;
        els.connectBtn.textContent = "Connected ✓";
        els.connectBtn.disabled = true;
        els.status.textContent = "Phantom connected!";
        state.provider = provider;
      } catch (err) {
        if (err.code === 4001) {
          els.status.textContent = "You rejected the connection";
        } else {
          els.status.textContent = "Connection failed: " + (err.message || "Unknown error");
        }
        els.status.classList.add('error');
        console.error("Phantom connect error:", err);
      }
    }

    // ==============================================
    // API CALLS
    // ==============================================
    async function fetchPairs() {
      try {
        const res = await fetch(`${CONFIG.API_BASE}/search?q=sol`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        return data.pairs || [];
      } catch (e) {
        console.error("DexScreener fetch error:", e);
        els.status.textContent = "API error – retrying soon...";
        return [];
      }
    }

    async function fetchPairDetail(addr) {
      try {
        const res = await fetch(`${CONFIG.API_BASE}/pairs/solana/${addr}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        return data.pair;
      } catch (e) {
        console.error("Pair detail fetch error:", e);
        return null;
      }
    }

    // ==============================================
    // FILTER & SORT
    // ==============================================
    function applyFilters(pairs) {
      const now = Date.now();

      return pairs.filter(p => {
        const liq = Number(p.liquidity?.usd || 0);
        const fdv = Number(p.fdv || 0);
        const vol = Number(p.volume?.h24 || 0);
        const ageSec = (now - new Date(p.pairCreatedAt).getTime()) / 1000;

        return (
          p.chainId === 'solana' &&
          p.quoteToken?.symbol === 'SOL' &&
          liq >= state.filters.minLiq &&
          fdv <= state.filters.maxFdv &&
          vol >= state.filters.minVol &&
          ageSec <= state.filters.maxAge
        );
      });
    }

    function sortByVolume(pairs) {
      return pairs.sort((a, b) => Number(b.volume?.h24 || 0) - Number(a.volume?.h24 || 0));
    }

    // ==============================================
    // RENDER TABLE
    // ==============================================
    function renderPairs(pairs) {
      let html = '';
      pairs.forEach(p => {
        const ageSec = Math.floor((Date.now() - new Date(p.pairCreatedAt).getTime()) / 1000);
        const age = ageSec < 60 ? `${ageSec}s` :
                    ageSec < 3600 ? `${Math.floor(ageSec/60)}m` :
                    ageSec < 86400 ? `${Math.floor(ageSec/3600)}h` : `${Math.floor(ageSec/86400)}d`;

        const price = Number(p.priceUsd || 0).toFixed(6);
        const ch24  = (p.priceChange?.h24 || 0).toFixed(1);
        const vol24 = Number(p.volume?.h24  || 0);
        const vol24Str = vol24.toLocaleString();
        const tx5m  = (p.txns?.m5?.buys || 0) + (p.txns?.m5?.sells || 0);
        const buyTx = p.txns?.m5?.buys || 0;
        const sellTx= p.txns?.m5?.sells || 0;
        const vol5mRaw = Number(p.volume?.m5  || 0);
        const vol5mStr = vol5mRaw.toLocaleString();
        const liq   = Number(p.liquidity?.usd || 0).toLocaleString();
        const fdv   = Number(p.fdv || 0).toLocaleString();
        const chCls = ch24 > 0 ? 'positive' : ch24 < 0 ? 'negative' : '';

        const vol24Class = getVolClass(vol24);
        const vol5mClass = getVolClass(vol5mRaw * 10);
        const ratioClass = getRatioClass(buyTx, sellTx);
        const ratioText  = formatRatio(buyTx, sellTx);

        const dsUrl = `https://dexscreener.com/solana/${p.pairAddress}`;

        html += `
          <tr>
            <td data-label="Token"><strong>${p.baseToken.symbol}</strong><br><small>${p.baseToken.name}</small></td>
            <td data-label="Price">$${price}</td>
            <td data-label="24h %" class="${chCls}">${ch24}%</td>
            <td data-label="Vol 24h" class="${vol24Class}">$${vol24Str}</td>
            <td data-label="5m Txns">${tx5m}</td>
            <td data-label="5m Buy Tx">${buyTx}</td>
            <td data-label="5m Sell Tx">${sellTx}</td>
            <td data-label="B/S Ratio (5m)" class="${ratioClass}">${ratioText}</td>
            <td data-label="5m Vol" class="${vol5mClass}">$${vol5mStr}</td>
            <td data-label="Liq">$${liq}</td>
            <td data-label="FDV">$${fdv}</td>
            <td data-label="Age">${age}</td>
            <td data-label="Actions">
              <a class="buy-btn" href="${dsUrl}" target="_blank">Buy on Dex</a>
              <a class="phantom-buy-btn" href="${dsUrl}" target="_blank">Phantom Buy</a>
              <a href="#" onclick="watchPair('${p.pairAddress}','${p.baseToken.symbol}')">Watch</a>
            </td>
          </tr>
        `;
      });

      els.pairs.innerHTML = html || '<tr><td colspan="13" style="text-align:center;padding:50px;color:#555;">No matching fresh high-volume gems right now</td></tr>';
      els.status.textContent = `Updated ${new Date().toLocaleTimeString()} • ${pairs.length} sorted by volume`;
    }

    // ==============================================
    // MAIN LOAD FUNCTION
    // ==============================================
    async function loadPairs() {
      els.status.textContent = "Scanning fresh high-volume Solana launches...";

      const allPairs = await fetchPairs();
      const filtered = applyFilters(allPairs);
      const sorted = sortByVolume(filtered);

      renderPairs(sorted.slice(0, 40));
    }

    // ==============================================
    // WATCH & ALERTS
    // ==============================================
    function watchPair(addr, sym) {
      watching = addr;
      els.chartArea.style.display = 'block';
      els.dexChart.src = `https://dexscreener.com/solana/${addr}`;
      window.scrollTo({top: els.chartArea.offsetTop - 80, behavior: 'smooth'});
      els.status.textContent = `Watching ${sym} – alerts ON`;

      els.buyAlert.style.display = els.sellAlert.style.display = 'none';
      prevBuyTx = prevSellTx = prevVol = 0;
      if (timer) clearInterval(timer);
      checkAlerts();
      timer = setInterval(checkAlerts, 15000);
    }

    async function checkAlerts() {
      if (!watching) return;
      const pair = await fetchPairDetail(watching);
      if (!pair) return;

      const buyTx  = pair.txns?.m5?.buys || 0;
      const sellTx = pair.txns?.m5?.sells || 0;
      const vol5m  = pair.volume?.m5 || 0;

      const bDelta = buyTx - prevBuyTx;
      const sDelta = sellTx - prevSellTx;
      const vDelta = vol5m - prevVol;

      if (bDelta >= 8 || (vDelta > 12000 && buyTx > sellTx * 1.4)) {
        els.buyAlert.textContent = `BUY ALERT • ${bDelta} buys • +$${Math.round(vDelta).toLocaleString()}`;
        els.buyAlert.style.display = 'block';
        els.beep.play().catch(() => {});
        setTimeout(() => els.buyAlert.style.display = 'none', 15000);
      }
      if (sDelta >= 8 || (vDelta > 10000 && sellTx > buyTx * 1.4)) {
        els.sellAlert.textContent = `SELL ALERT • ${sDelta} sells dumping`;
        els.sellAlert.style.display = 'block';
        els.beep.play().catch(() => {});
        setTimeout(() => els.sellAlert.style.display = 'none', 15000);
      }

      prevBuyTx = buyTx;
      prevSellTx = sellTx;
      prevVol = vol5m;
    }

    // ==============================================
    // INIT & AUTO-REFRESH
    // ==============================================
    loadPairs();
    setInterval(loadPairs, CONFIG.REFRESH_INTERVAL);
  </script>
</body>
</html>
